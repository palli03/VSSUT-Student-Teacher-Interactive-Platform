<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Class Notes & Assignments</title>
    <style>
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --background-light: #f8f9fa; /* Light Gray/White */
            --text-dark: #343a40; /* Dark Gray */
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; background-color: var(--background-light); color: var(--text-dark); }
        .header { background-color: var(--primary-color); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .top-nav a { color: white; text-decoration: none; margin-left: 20px; padding: 5px 10px; border-radius: 4px; }
        .top-nav a:hover { background-color: rgba(255, 255, 255, 0.2); }
        .container { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 250px; background-color: #ffffff; border-right: 1px solid var(--border-color); padding: 20px 0; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); }
        .nav-item { display: block; padding: 12px 30px; color: var(--text-dark); text-decoration: none; font-size: 1rem; transition: background-color 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background-color: var(--background-light); }
        .nav-item.active { background-color: var(--primary-color); color: white; font-weight: bold; border-left: 3px solid #ffc107; }
        .nav-item.active:hover { background-color: var(--primary-color); }
        .main-content { flex-grow: 1; padding: 30px; }
        .page-title { font-size: 2rem; color: var(--primary-color); margin-bottom: 5px; }
        .subtitle { color: var(--secondary-color); margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .form-card { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.05); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="file"] { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5); }
        .form-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s; }
        .btn.primary { background-color: var(--primary-color); color: white; }
        .btn.primary:hover { background-color: #0056b3; }
        .btn.secondary { background-color: var(--secondary-color); color: white; }
        .btn.secondary:hover { background-color: #5a6268; }
        .file-upload-info { font-size: 0.9rem; color: var(--secondary-color); margin-top: 5px; }
        .notes-table-container { margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.05); }
        .notes-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .notes-table th, .notes-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .notes-table th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; font-size: 0.9rem; }
        .notes-table tr:hover { background-color: var(--background-light); }
        .download-link { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .download-link:hover { text-decoration: underline; }
        .hidden { display: none; }
        .status-success { color: #155724; }
        .status-error { color: #721c24; }
        /* --- NEW: Added margin for the new table --- */
        .teacher-posts-container {
             margin-top: 30px; 
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">VSSUT Student-Teacher Interactive Platform</div>
        <nav class="top-nav">
            <a href="dash.html">Home</a>
            <a href="#" id="logoutLink">Logout</a>
        </nav>
    </header>

    <div class="container">
        <aside class="sidebar">
            <nav class="side-nav">
                <a href="dash.html" class="nav-item">Dashboard</a>
                <a href="newindex.html" class="nav-item">Edit Profile</a>
                <a href="classes.html" class="nav-item">Classes</a>
                <a href="notification.html" class="nav-item active">Notifications</a>
                <a href="doubts.html" class="nav-item">Doubts</a>
                <a href="exam.html" class="nav-item">Exams</a>
            </nav>
        </aside>

        <main class="main-content">
            <div id="teacherView" class="view-section hidden">
                <h2 class="page-title">Post Study Materials & Notes</h2>
                <p class="subtitle">Select a course and upload relevant documents, slides, or assignments.</p>

                <div class="form-card">
                    <form id="postForm">
                        <div class="form-group">
                            <label for="courseSelect">Course</label>
                            <select id="courseSelect" required>
                                <option value="">-- Select a course --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="postTitle">Title / Topic Name</label>
                            <input type="text" id="postTitle" placeholder="e.g., Week 5: Linked Lists Notes" required>
                        </div>
                        <div class="form-group">
                            <label for="postDescription">Description</label>
                            <textarea id="postDescription" rows="4" placeholder="Brief summary..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fileUpload">Upload Class Notes / Material</label>
                            <input type="file" id="fileUpload" accept=".pdf, .ppt, .pptx, image/jpeg, image/png" required>
                            <p class="file-upload-info">Accepted formats: PDF, PPT/PPTX, JPEG, PNG.</p>
                            <div id="uploadStatus" class="mt-2 text-sm" style="margin-top: 8px;"></div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn secondary" id="resetForm">Reset</button>
                            <button type="submit" class="btn primary">Post Material</button>
                        </div>
                    </form>
                </div>

                <div class="notes-table-container teacher-posts-container">
                    <h3 class="page-title" style="font-size: 1.5rem;">My Posted Materials</h3>
                    <table class="notes-table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Title / Topic</th>
                                <th>Date Posted</th>
                                <th>File Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="teacherNotesTableBody">
                            </tbody>
                    </table>
                </div>
                </div>

            <div id="studentView" class="view-section hidden">
                <h2 class="page-title">Course Notes & Study Materials</h2>
                <p class="subtitle">View and download notes shared by your teachers for enrolled courses.</p>
                <div class="notes-table-container">
                    <div class="form-group">
                        <label for="studentCourseSelect">Filter by Course</label>
                        <select id="studentCourseSelect">
                            <option value="">-- Show All Courses --</option>
                        </select>
                    </div>
                    <table class="notes-table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Title / Topic</th>
                                <th>Date Posted</th>
                                <th>File Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="notesTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function() {
            function checkLogin() {
                const user = localStorage.getItem('currentUsername');
                if (!user) {
                    // window.location.replace() removes the current page from history
                    // so the user cannot click "Back" to return to it.
                    window.location.replace('index.html');
                }
            }

            // 1. Check immediately when the script runs
            checkLogin();

            // 2. Check again if the page is loaded from the browser's "Back" cache
            window.addEventListener('pageshow', function(event) {
                checkLogin();
            });
        })();
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. Route Guard ---
            (function() {
                const loggedInUser = localStorage.getItem('currentUsername');
                if (!loggedInUser) {
                    alert('You are not logged in. Redirecting...');
                    window.location.href = 'index.html';
                    throw new Error("User not logged in."); 
                }
            })();
            
            // --- 2. Define all variables ---
            const API_URL = 'http://127.0.0.1:5000';
            const USER_ROLE_KEY = 'currentUserRole';
            
            const teacherView = document.getElementById('teacherView');
            const studentView = document.getElementById('studentView');
            const logoutLink = document.getElementById('logoutLink');
            
            const postForm = document.getElementById('postForm');
            const courseSelect = document.getElementById('courseSelect');
            const uploadStatus = document.getElementById('uploadStatus');

            const studentCourseSelect = document.getElementById('studentCourseSelect');
            const notesTableBody = document.getElementById('notesTableBody');
            const teacherNotesTableBody = document.getElementById('teacherNotesTableBody');

            const currentUserRole = localStorage.getItem(USER_ROLE_KEY) || 'student';

            // --- 3. Helper Functions ---
            function handleLogout(event) {
                event.preventDefault();
                localStorage.removeItem('currentUserRole');
                localStorage.removeItem('currentUsername');
                window.location.href = 'index.html'; 
            }
            logoutLink.addEventListener('click', handleLogout);

            function getCourses() {
                return fetch(`${API_URL}/api/courses`) 
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to fetch courses');
                        return res.json();
                    })
                    .catch(err => {
                        console.error('Failed to fetch courses:', err);
                        return [];
                    });
            }
            
            async function loadCoursesForTeacher() {
                const courses = await getCourses();
                courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.courseCode;
                    option.textContent = `${course.name} (${course.courseCode})`;
                    courseSelect.appendChild(option);
                });
            }
            
            async function loadCoursesForStudent(selectedCourseCode) {
                const courses = await getCourses();
                studentCourseSelect.innerHTML = '<option value="">-- Show All Courses --</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.courseCode;
                    option.textContent = `${course.name} (${course.courseCode})`;
                    if (course.courseCode === selectedCourseCode) option.selected = true;
                    studentCourseSelect.appendChild(option);
                });
            }

            function getPosts(courseCode = '') {
                let url = `${API_URL}/api/posts`;
                if (courseCode) {
                    url = `${url}?courseCode=${courseCode}`;
                }
                return fetch(url)
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to fetch posts');
                        return res.json();
                    })
                    .catch(err => {
                        console.error('Failed to fetch posts:', err);
                        return [];
                    });
            }

            // --- ### NEW: Delete Function ### ---
            async function deletePost(postId) {
                if (!confirm("Are you sure you want to delete this material? This cannot be undone.")) {
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/posts/${postId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        // Refresh the list immediately
                        renderTeacherPosts();
                        // Also refresh student view just in case (though hidden)
                        renderStudentNotes();
                    } else {
                        alert("Failed to delete post.");
                    }
                } catch (error) {
                    console.error("Error deleting post:", error);
                    alert("Error connecting to server.");
                }
            }
            // --- ### END NEW FUNCTION ### ---

            async function renderStudentNotes(filterCourseCode = '') {
                const filteredPosts = await getPosts(filterCourseCode);
                notesTableBody.innerHTML = ''; 
                if (filteredPosts.length === 0) {
                    notesTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d; padding: 20px;">No notes available for this selection.</td></tr>';
                    return;
                }
                filteredPosts.sort((a, b) => new Date(b.postDate) - new Date(a.postDate));
                filteredPosts.forEach(post => {
                    const row = notesTableBody.insertRow();
                    const downloadUrl = `${API_URL}/uploads/${post.fileName}`;
                    row.innerHTML = `
                        <td>${post.courseName || post.courseCode}</td>
                        <td><strong>${post.title}</strong><br><small style="color: #6c757d;">${post.description ? post.description.substring(0, 50) + '...' : ''}</small></td>
                        <td>${new Date(post.postDate).toLocaleDateString()}</td>
                        <td>${post.fileName}</td>
                        <td><a href="${downloadUrl}" target="_blank" class="download-link">Download</a></td>
                    `;
                });
            }
            
            async function renderTeacherPosts() {
                const allPosts = await getPosts(); 
                teacherNotesTableBody.innerHTML = ''; 
                
                if (allPosts.length === 0) {
                    teacherNotesTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d; padding: 20px;">You have not posted any materials yet.</td></tr>';
                    return;
                }
                
                allPosts.forEach(post => {
                    const row = teacherNotesTableBody.insertRow();
                    const downloadUrl = `${API_URL}/uploads/${post.fileName}`;
                    
                    // --- ### MODIFIED: Added Delete Button ### ---
                    row.innerHTML = `
                        <td>${post.courseName || post.courseCode}</td>
                        <td><strong>${post.title}</strong></td>
                        <td>${new Date(post.postDate).toLocaleDateString()}</td>
                        <td>${post.fileName}</td>
                        <td>
                            <a href="${downloadUrl}" target="_blank" class="download-link" style="margin-right: 10px;">View</a>
                            <button class="btn secondary delete-btn" 
                                    data-id="${post._id}" 
                                    style="padding: 4px 8px; font-size: 0.8rem; background-color: #dc3545; border-color: #dc3545;">
                                Delete
                            </button>
                        </td>
                    `;
                });

                // Attach event listeners to new delete buttons
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const postId = this.getAttribute('data-id');
                        deletePost(postId);
                    });
                });
                // --- ### END MODIFIED ### ---
            }
            
            // --- 4. Initialization Logic (Role check) ---
            if (currentUserRole === 'student') {
                teacherView.classList.add('hidden');
                studentView.classList.remove('hidden');
                loadCoursesForStudent(''); 
                renderStudentNotes(); 
                studentCourseSelect.addEventListener('change', function() {
                    renderStudentNotes(this.value); 
                });
                
            } else { 
                studentView.classList.add('hidden');
                teacherView.classList.remove('hidden');
                loadCoursesForTeacher(); 
                renderTeacherPosts(); 

                postForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    const courseCode = courseSelect.value;
                    const postTitle = document.getElementById('postTitle').value.trim();
                    const postDescription = document.getElementById('postDescription').value.trim();
                    const fileInput = document.getElementById('fileUpload');
                    const file = fileInput.files[0];
                    
                    if (!courseCode || !file) {
                        alert('Please select a course and a file.');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('courseCode', courseCode);
                    formData.append('postTitle', postTitle);
                    formData.append('postDescription', postDescription);
                    formData.append('fileUpload', file);
                    const courseName = courseSelect.options[courseSelect.selectedIndex].text;
                    formData.append('courseName', courseName);
                    formData.append('postDate', new Date().toISOString());

                    uploadStatus.textContent = 'Uploading...';
                    uploadStatus.classList.remove('status-error', 'status-success');

                    try {
                        const response = await fetch(`${API_URL}/api/posts`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'Upload failed');
                        
                        uploadStatus.textContent = `Successfully posted "${postTitle}".`;
                        uploadStatus.classList.add('status-success');
                        postForm.reset();
                        
                        renderTeacherPosts(); 
                        
                    } catch (error) {
                        console.error('Upload Error:', error);
                        uploadStatus.textContent = `Error: ${error.message}`;
                        uploadStatus.classList.add('status-error');
                    }
                });
                
                document.getElementById('resetForm').addEventListener('click', function() {
                    postForm.reset();
                    uploadStatus.textContent = '';
                });
            }
        });
    </script>
</body>
</html>